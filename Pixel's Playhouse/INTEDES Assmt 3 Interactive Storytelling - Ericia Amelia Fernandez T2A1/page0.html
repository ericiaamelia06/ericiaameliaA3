<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>The Discovery</title>
    <style>
        :root {
            --cyan: #4ff6ff;
            --deep-blue: #061634;
            --ink: #030b1c;
            --panel: rgba(2, 12, 31, 0.86);
            --text: #d8f7ff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: grid;
            place-items: center;
            background: radial-gradient(circle at 50% 20%, #0e244f 0%, #040a18 65%, #02050e 100%);
            font-family: "Share Tech Mono", "Courier New", monospace;
            color: var(--text);
            overflow: hidden;
        }

        .game {
            position: relative;
            width: 960px;
            height: 540px;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            border: 2px solid rgba(79, 246, 255, 0.35);
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.28), inset 0 0 80px rgba(0, 0, 0, 0.3);
            background: #000;
        }

        .scene-bg {
            position: absolute;
            inset: 0;
            background-image: url("livingroom-bg.png");
            background-size: cover;
            background-position: center;
            filter: brightness(0.74) saturate(0.92);
            transition: filter 500ms ease;
        }

        .intro-black {
            position: absolute;
            inset: 0;
            background: #000;
            opacity: 1;
            z-index: 40;
            pointer-events: none;
            transition: opacity 900ms ease;
        }

        .intro-black.fade-out {
            opacity: 0;
        }

        .blue-wash {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 64% 52%, rgba(76, 206, 255, 0.28), rgba(0, 0, 0, 0.05) 32%, rgba(0, 0, 0, 0.36) 78%);
            opacity: 0;
            transition: opacity 400ms ease;
            pointer-events: none;
        }

        .blue-wash.active {
            opacity: 1;
        }

        .dialogue-box {
            position: absolute;
            left: 20px;
            right: 20px;
            bottom: 18px;
            min-height: 115px;
            background: linear-gradient(180deg, rgba(4, 20, 49, 0.88), rgba(2, 11, 28, 0.94));
            border: 1px solid rgba(84, 245, 255, 0.5);
            border-radius: 14px;
            padding: 16px 18px;
            box-shadow: 0 0 18px rgba(0, 200, 255, 0.35);
            line-height: 1.45;
            z-index: 5;
        }

        .dialogue-name {
            display: inline-block;
            font-size: 12px;
            letter-spacing: 1.2px;
            color: #86f8ff;
            margin-bottom: 7px;
            text-transform: uppercase;
        }

        .dialogue-text {
            font-size: clamp(14px, 1.8vw, 20px);
        }

        .monitor-hotspot {
            position: absolute;
            left: 0;
            top: 0;
            width: 960px;
            height: 540px;
            clip-path: polygon(156px 186px, 250px 173px, 256px 244px, 162px 261px);
            -webkit-clip-path: polygon(156px 186px, 250px 173px, 256px 244px, 162px 261px);
            border: 7px solid rgba(255, 120, 255, 1);
            background: rgba(255, 120, 255, 0.22);
            box-shadow: 0 0 28px rgba(255, 120, 255, 1), 0 0 76px rgba(255, 40, 210, 0.98);
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            z-index: 8;
            transition: opacity 220ms ease, filter 180ms ease, box-shadow 180ms ease;
            animation: monitorPulse 1.2s ease-in-out infinite;
        }

        .monitor-hotspot.active {
            opacity: 1;
            pointer-events: auto;
        }

        .monitor-hotspot.active:hover {
            filter: brightness(1.08);
            box-shadow: 0 0 20px rgba(96, 246, 255, 1), 0 0 56px rgba(0, 206, 255, 0.56);
        }

        .door-hotspot {
            position: absolute;
            left: 0;
            top: 0;
            width: 960px;
            height: 540px;
            clip-path: polygon(757px 35px, 925px 21px, 884px 506px, 735px 433px);
            -webkit-clip-path: polygon(757px 35px, 925px 21px, 884px 506px, 735px 433px);
            border: 7px solid rgba(178, 255, 95, 1);
            background: rgba(178, 255, 95, 0.2);
            box-shadow: 0 0 24px rgba(178, 255, 95, 0.96), 0 0 62px rgba(124, 255, 44, 0.64);
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            z-index: 7;
            transition: opacity 220ms ease, filter 180ms ease, box-shadow 180ms ease;
            animation: doorPulse 1.35s ease-in-out infinite;
            border-radius: 0;
            padding: 0;
        }

        .door-hotspot.active {
            opacity: 1;
            pointer-events: auto;
        }

        .door-hotspot.active:hover {
            filter: brightness(1.06);
            box-shadow: 0 0 22px rgba(255, 230, 160, 0.82), 0 0 54px rgba(255, 200, 100, 0.38);
        }

        .door-instruction {
            position: absolute;
            right: 36px;
            bottom: 136px;
            background: rgba(61, 34, 15, 0.82);
            border: 1px solid rgba(255, 228, 161, 0.78);
            border-radius: 999px;
            padding: 6px 10px;
            color: #ffeec3;
            font-size: clamp(10px, 1.05vw, 12px);
            letter-spacing: 0.6px;
            box-shadow: 0 0 12px rgba(255, 217, 145, 0.24);
            opacity: 0;
            transition: opacity 250ms ease;
            pointer-events: none;
            z-index: 10;
        }

        .door-instruction.active {
            opacity: 1;
        }

        .computer-instruction {
            position: absolute;
            left: 120px;
            top: 136px;
            background: rgba(61, 34, 15, 0.82);
            border: 1px solid rgba(255, 228, 161, 0.78);
            border-radius: 999px;
            padding: 6px 10px;
            color: #ffeec3;
            font-size: clamp(10px, 1.05vw, 12px);
            letter-spacing: 0.6px;
            box-shadow: 0 0 12px rgba(255, 217, 145, 0.24);
            opacity: 0;
            transition: opacity 250ms ease;
            pointer-events: none;
            z-index: 10;
        }

        .computer-instruction.active {
            opacity: 1;
        }

        .chat-layer {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12;
            padding: 20px;
        }

        .chat-layer.active {
            display: flex;
        }

        .chat-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.58);
            backdrop-filter: blur(1.8px);
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 180ms ease;
        }

        .chat-layer.chat-open .chat-backdrop {
            opacity: 1;
        }

        .scanline {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: repeating-linear-gradient(to bottom, rgba(112, 249, 255, 0.05) 0, rgba(112, 249, 255, 0.05) 1px, transparent 1px, transparent 3px);
            z-index: 11;
            opacity: 0;
        }

        .chat-layer.active .scanline {
            opacity: 1;
        }

        .notification {
            width: min(520px, 100%);
            background: linear-gradient(180deg, rgba(5, 24, 58, 0.96), rgba(2, 14, 37, 0.96));
            border: 1px solid rgba(79, 246, 255, 0.62);
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 0 28px rgba(0, 198, 255, 0.45);
            text-align: center;
            position: relative;
            z-index: 13;
            animation: popupIn 220ms ease-out;
        }

        .notification h2 {
            margin: 0 0 12px;
            color: #9ff8ff;
            font-size: clamp(15px, 1.9vw, 23px);
            letter-spacing: 0.9px;
        }

        .notification p {
            margin: 0 0 18px;
            color: #dffcff;
            font-size: clamp(13px, 1.7vw, 20px);
        }

        .btn-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            border: 1px solid rgba(114, 247, 255, 0.8);
            border-radius: 999px;
            background: rgba(4, 28, 60, 0.9);
            color: #d6f8ff;
            padding: 9px 16px;
            cursor: pointer;
            font-family: inherit;
            transition: transform 180ms ease, box-shadow 180ms ease, filter 180ms ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 12px rgba(70, 237, 255, 0.5);
            filter: brightness(1.08);
        }

        .accept {
            background: rgba(0, 161, 200, 0.25);
        }

        .decline {
            background: rgba(103, 16, 16, 0.42);
            border-color: rgba(255, 154, 154, 0.6);
        }

        .chat-window {
            width: min(700px, 100%);
            height: min(420px, 88%);
            background: linear-gradient(180deg, rgba(3, 20, 48, 0.95), rgba(2, 10, 28, 0.95));
            border: 1px solid rgba(79, 246, 255, 0.58);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 194, 255, 0.48);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 13;
        }

        .chat-window.active {
            display: flex;
            animation: popupIn 220ms ease-out;
        }

        .chat-header {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(79, 246, 255, 0.35);
            background: rgba(0, 10, 27, 0.72);
            color: #9bf9ff;
            font-size: clamp(13px, 1.5vw, 17px);
            letter-spacing: 0.8px;
        }

        .chat-log {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            max-width: 100%;
        }

        .chat-row.npc {
            align-self: flex-start;
        }

        .chat-row.player {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid rgba(144, 240, 255, 0.6);
            object-fit: cover;
            flex: 0 0 auto;
            box-shadow: 0 0 10px rgba(0, 200, 255, 0.28);
            background: #08152f;
        }

        .msg {
            max-width: 430px;
            padding: 10px 12px;
            border-radius: 12px;
            font-size: clamp(12px, 1.4vw, 16px);
            line-height: 1.35;
            border: 1px solid transparent;
            white-space: pre-wrap;
        }

        .msg-name {
            font-size: 11px;
            letter-spacing: 0.4px;
            opacity: 0.85;
            margin-bottom: 2px;
        }

        .msg-text {
            white-space: pre-wrap;
        }

        .msg.npc {
            background: rgba(0, 170, 210, 0.2);
            border-color: rgba(98, 246, 255, 0.55);
        }

        .msg.player {
            background: rgba(0, 62, 140, 0.45);
            border-color: rgba(138, 208, 255, 0.5);
        }

        .chat-choice {
            display: none;
            gap: 10px;
            padding: 0 14px 14px;
            flex-wrap: wrap;
        }

        .chat-choice.active {
            display: flex;
        }

        .file-btn {
            border-radius: 8px;
            border: 1px solid rgba(85, 244, 255, 0.6);
            background: rgba(4, 34, 72, 0.8);
            padding: 10px 12px;
            text-align: left;
            font-size: clamp(11px, 1.3vw, 14px);
            margin-top: 2px;
            max-width: 430px;
        }

        .file-btn span {
            display: block;
            color: #90f7ff;
            margin-bottom: 3px;
            font-size: clamp(11px, 1.2vw, 13px);
        }

        .collapse-overlay {
            position: absolute;
            inset: 0;
            background: #030a1d;
            opacity: 0;
            pointer-events: none;
            z-index: 30;
            transition: opacity 140ms linear;
        }

        .collapse-overlay.active {
            opacity: 1;
        }

        .collapse-overlay.blackout {
            background: #000;
        }

        .collapse-line {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #fff;
            transform: translate(-50%, -50%);
            opacity: 0;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.75);
        }

        .collapse-dot {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
        }

        .collapse-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #7dff6f;
            font-size: clamp(30px, 4vw, 56px);
            letter-spacing: 1px;
            font-weight: 800;
            text-shadow: 0 0 12px rgba(125, 255, 111, 0.9), 0 0 24px rgba(70, 230, 95, 0.55);
            white-space: nowrap;
            z-index: 2;
        }

        .code-rain {
            position: absolute;
            inset: 0;
            overflow: hidden;
            opacity: 0;
            transition: opacity 260ms ease;
            z-index: 1;
            pointer-events: none;
        }

        .collapse-overlay.show-code .code-rain {
            opacity: 0.78;
        }

        .edu-popup {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: min(700px, calc(100% - 40px));
            background: rgba(8, 18, 36, 0.95);
            border: 1px solid rgba(255, 225, 128, 0.72);
            border-radius: 14px;
            padding: 20px 20px 16px;
            box-shadow: 0 0 22px rgba(255, 210, 100, 0.22);
            opacity: 0;
            pointer-events: none;
            z-index: 4;
            color: #dce9ff;
        }

        .edu-popup.active {
            opacity: 1;
            pointer-events: auto;
        }

        .collapse-overlay.show-edu {
            pointer-events: auto;
        }

        .edu-head {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffd77a;
            font-weight: 800;
            font-size: clamp(18px, 2.1vw, 26px);
            letter-spacing: 0.65px;
            margin-bottom: 10px;
        }

        .edu-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            flex: 0 0 auto;
        }

        .edu-body {
            font-size: clamp(13px, 1.3vw, 17px);
            line-height: 1.45;
            margin-bottom: 14px;
            color: #d4e4ff;
        }

        .edu-continue {
            border-color: rgba(255, 225, 128, 0.72);
            background: rgba(90, 62, 15, 0.66);
            color: #ffe9aa;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            display: block;
            margin-left: auto;
        }

        .code-col {
            position: absolute;
            top: -100%;
            color: rgba(116, 255, 116, 0.55);
            font-size: 14px;
            line-height: 1.05;
            white-space: pre;
            text-shadow: 0 0 8px rgba(90, 255, 120, 0.48);
            animation: codeFall linear infinite;
        }

        .collapse-overlay.collapse .collapse-line {
            animation: lineCollapse 360ms ease-in forwards, lineFade 100ms linear 320ms forwards;
        }

        .collapse-overlay.collapse .collapse-dot {
            animation: dotAppear 180ms ease-out 240ms forwards, dotVanish 160ms linear 520ms forwards;
        }

        .game.shaking {
            animation: shake 0.24s linear infinite;
        }

        .glitch-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            z-index: 20;
            mix-blend-mode: screen;
        }

        .glitch-layer.active {
            opacity: 1;
            animation: glitchFlicker 140ms steps(2, end) infinite;
        }

        .glitch-layer::before,
        .glitch-layer::after {
            content: "";
            position: absolute;
            inset: -8px;
            background-image:
                repeating-linear-gradient(
                    to bottom,
                    rgba(255, 255, 255, 0.28) 0,
                    rgba(255, 255, 255, 0.28) 1px,
                    transparent 1px,
                    transparent 4px
                ),
                linear-gradient(90deg, rgba(255, 0, 80, 0.22), rgba(0, 170, 255, 0.22));
        }

        .glitch-layer::before {
            transform: translateX(-5px);
            clip-path: polygon(0 0, 100% 0, 100% 22%, 0 30%);
        }

        .glitch-layer::after {
            transform: translateX(5px);
            clip-path: polygon(0 37%, 100% 29%, 100% 100%, 0 100%);
        }

        @keyframes shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-2px, 2px) rotate(-0.3deg); }
            40% { transform: translate(3px, -1px) rotate(0.35deg); }
            60% { transform: translate(-2px, -2px) rotate(-0.25deg); }
            80% { transform: translate(2px, 1px) rotate(0.2deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes doorPulse {
            0%,
            100% {
                box-shadow: 0 0 14px rgba(255, 220, 140, 0.6), 0 0 34px rgba(255, 182, 78, 0.24);
            }
            50% {
                box-shadow: 0 0 22px rgba(255, 235, 175, 0.84), 0 0 52px rgba(255, 196, 98, 0.4);
            }
        }

        @keyframes monitorPulse {
            0%,
            100% {
                box-shadow: 0 0 24px rgba(120, 247, 255, 1), 0 0 58px rgba(0, 216, 255, 0.74);
            }
            50% {
                box-shadow: 0 0 34px rgba(170, 255, 255, 1), 0 0 82px rgba(0, 234, 255, 0.95);
            }
        }

        @keyframes glitchFlicker {
            0% { opacity: 0.35; }
            45% { opacity: 0.8; }
            100% { opacity: 0.45; }
        }

        @keyframes lineCollapse {
            from {
                opacity: 1;
                width: 100%;
            }
            to {
                opacity: 1;
                width: 1px;
            }
        }

        @keyframes lineFade {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes dotAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes dotVanish {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
        }

        @keyframes codeFall {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(340%);
            }
        }

        @keyframes popupIn {
            from {
                transform: translateY(10px) scale(0.98);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <main class="game" id="gameFrame" aria-label="Interactive story scene">
        <div class="scene-bg" id="sceneBg"></div>
        <div class="blue-wash" id="blueWash"></div>
        <div class="intro-black" id="introBlack"></div>

        <button class="door-hotspot" id="doorHotspot" aria-label="Head to bedroom"></button>
        <div class="door-instruction" id="doorInstruction">CLICK THE BEDROOM DOOR</div>

        <button class="monitor-hotspot" id="monitorHotspot" aria-label="Investigate the glowing monitor"></button>
        <div class="computer-instruction" id="computerInstruction">CLICK THE COMPUTER SCREEN</div>

        <section class="dialogue-box" id="dialogueBox">
            <div class="dialogue-name">You</div>
            <div class="dialogue-text" id="dialogueText"></div>
        </section>

        <section class="chat-layer" id="chatLayer" aria-label="Chat interface">
            <div class="chat-backdrop"></div>
            <div class="scanline"></div>

            <div class="notification" id="notification">
                <h2>Incoming Follow Request</h2>
                <p>Follow request from: <strong>Protocol_9</strong></p>
                <div class="btn-row">
                    <button class="accept" id="acceptBtn">ACCEPT</button>
                    <button class="decline" id="declineBtn">DECLINE</button>
                </div>
            </div>

            <div class="chat-window" id="chatWindow">
                <div class="chat-header">SECURE CHAT : Protocol_9</div>
                <div class="chat-log" id="chatLog"></div>
                <div class="chat-choice" id="chatChoice"></div>
            </div>
        </section>

        <div class="glitch-layer" id="glitchLayer"></div>
        <div class="collapse-overlay" id="collapseOverlay">
            <div class="code-rain" id="codeRain"></div>
            <div class="collapse-line"></div>
            <div class="collapse-dot"></div>
            <div class="collapse-text" id="collapseText"></div>
            <div class="edu-popup" id="eduPopup">
                <div class="edu-head">
                    <img class="edu-icon" src="alert-icon-yellow.png" alt="Alert icon">
                    <span>GROOMING: TRUST-BUILDING</span>
                </div>
                <div class="edu-body">
                    Online grooming often begins with flattery, special treatment, and exclusive opportunities.<br><br>
                    If someone pressures you to keep secrets or download files privately, it's a red flag.
                </div>
                <button class="edu-continue" id="eduContinueBtn">CONTINUE</button>
            </div>
        </div>
    </main>

    <audio id="walkingSfx" src="walking-sfx.mp3" preload="auto"></audio>
    <audio id="notificationSfx" src="notification-sfx.mp3" preload="auto"></audio>
    <audio id="glitchSfx" src="glitch-sfx.mp3" preload="auto"></audio>
    <audio id="doorCloseSfx" src="door-close-sfx.mp3" preload="auto"></audio>

    <script>
        const dialogueText = document.getElementById("dialogueText");
        const dialogueName = document.querySelector(".dialogue-name");
        const doorHotspot = document.getElementById("doorHotspot");
        const doorInstruction = document.getElementById("doorInstruction");
        const monitorHotspot = document.getElementById("monitorHotspot");
        const computerInstruction = document.getElementById("computerInstruction");
        const blueWash = document.getElementById("blueWash");
        const sceneBg = document.getElementById("sceneBg");
        const introBlack = document.getElementById("introBlack");

        const chatLayer = document.getElementById("chatLayer");
        const notification = document.getElementById("notification");
        const chatWindow = document.getElementById("chatWindow");
        const chatLog = document.getElementById("chatLog");
        const chatChoice = document.getElementById("chatChoice");
        const acceptBtn = document.getElementById("acceptBtn");
        const declineBtn = document.getElementById("declineBtn");

        const gameFrame = document.getElementById("gameFrame");
        const glitchLayer = document.getElementById("glitchLayer");
        const collapseOverlay = document.getElementById("collapseOverlay");
        const collapseText = document.getElementById("collapseText");
        const codeRain = document.getElementById("codeRain");
        const eduPopup = document.getElementById("eduPopup");
        const eduContinueBtn = document.getElementById("eduContinueBtn");

        const walkingSfx = document.getElementById("walkingSfx");
        const notificationSfx = document.getElementById("notificationSfx");
        const glitchSfx = document.getElementById("glitchSfx");
        const doorCloseSfx = document.getElementById("doorCloseSfx");
        const protocolProfile = "empty-profile.png";
        const playerProfile = "lizard-profile.png";

        let sceneLocked = false;
        let inLivingRoom = true;
        let typingTimer = null;
        let typingToken = 0;
        let collapseTypeTimer = null;

        function setDialogue(text) {
            dialogueText.textContent = text;
        }

        function setDialogueSpeaker(name) {
            if (!name) {
                dialogueName.style.display = "none";
                return;
            }
            dialogueName.style.display = "inline-block";
            dialogueName.textContent = name;
        }

        function typeDialogue(text, onComplete, speed = 30) {
            typingToken += 1;
            const token = typingToken;
            clearTimeout(typingTimer);
            dialogueText.textContent = "";
            let i = 0;

            function step() {
                if (token !== typingToken) return;
                if (i < text.length) {
                    dialogueText.textContent += text[i];
                    i += 1;
                    typingTimer = setTimeout(step, speed);
                    return;
                }
                if (onComplete) onComplete();
            }

            step();
        }

        function addMessage(speakerClass, name, text) {
            const row = document.createElement("div");
            row.className = `chat-row ${speakerClass}`;

            const avatar = document.createElement("img");
            avatar.className = "chat-avatar";
            avatar.alt = `${name} profile`;
            avatar.src = speakerClass === "npc" ? protocolProfile : playerProfile;

            const bubble = document.createElement("div");
            bubble.className = `msg ${speakerClass}`;

            const label = document.createElement("div");
            label.className = "msg-name";
            label.textContent = name;

            const content = document.createElement("div");
            content.className = "msg-text";
            content.textContent = text;

            bubble.appendChild(label);
            bubble.appendChild(content);
            row.appendChild(avatar);
            row.appendChild(bubble);
            chatLog.appendChild(row);
            chatLog.scrollTop = chatLog.scrollHeight;
            return row;
        }

        function addFileAttachment() {
            const row = document.createElement("div");
            row.className = "chat-row npc";

            const avatar = document.createElement("img");
            avatar.className = "chat-avatar";
            avatar.alt = "Protocol_9 profile";
            avatar.src = protocolProfile;

            const fileButton = document.createElement("button");
            fileButton.className = "file-btn";
            fileButton.innerHTML = "<span>FILE ATTACHMENT</span>Pixels_Playhouse.exe";
            fileButton.addEventListener("click", startGlitchSequence, { once: true });

            row.appendChild(avatar);
            row.appendChild(fileButton);
            chatLog.appendChild(row);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function wait(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
        }

        function typeCollapseText(text, onComplete, speed = 70) {
            clearTimeout(collapseTypeTimer);
            collapseText.textContent = "";
            let i = 0;

            function step() {
                if (i < text.length) {
                    collapseText.textContent += text[i];
                    i += 1;
                    collapseTypeTimer = setTimeout(step, speed);
                    return;
                }
                if (onComplete) onComplete();
            }

            step();
        }

        function buildCodeRain() {
            const columns = 34;
            codeRain.innerHTML = "";
            for (let i = 0; i < columns; i += 1) {
                const col = document.createElement("div");
                col.className = "code-col";
                col.style.left = `${(i / columns) * 100}%`;
                col.style.animationDuration = `${2.4 + Math.random() * 1.6}s`;
                col.style.animationDelay = `${-Math.random() * 4}s`;
                col.textContent = Array.from({ length: 30 }, () => (
                    Math.random() > 0.5 ? "1" : "0"
                )).join("\n");
                codeRain.appendChild(col);
            }
        }

        function chooseOption(options) {
            chatChoice.innerHTML = "";
            chatChoice.classList.add("active");

            return new Promise((resolve) => {
                options.forEach((optionText) => {
                    const button = document.createElement("button");
                    button.textContent = optionText;
                    button.addEventListener("click", () => {
                        if (!chatChoice.classList.contains("active")) return;
                        chatChoice.classList.remove("active");
                        addMessage("player", "You", optionText);
                        resolve(optionText);
                    }, { once: true });
                    chatChoice.appendChild(button);
                });
            });
        }

        function prepareLivingRoomScene() {
            sceneBg.style.backgroundImage = 'url("livingroom-bg.png")';
            sceneBg.style.filter = "brightness(0.82) saturate(0.92)";
            blueWash.classList.remove("active");
            monitorHotspot.classList.remove("active");
            computerInstruction.classList.remove("active");
            doorHotspot.classList.remove("active");
            doorInstruction.classList.remove("active");
            dialogueText.textContent = "";
        }

        function initLivingRoomScene() {
            setDialogueSpeaker("You");
            typeDialogue('"Ugh, that was so tiring... seriously wish I could\'ve just skipped today... My brain is fried..."', () => {
                doorHotspot.classList.add("active");
                doorInstruction.classList.add("active");
            });
        }

        function startIntroSequence() {
            prepareLivingRoomScene();
            doorCloseSfx.currentTime = 0;
            doorCloseSfx.volume = 0.92;
            doorCloseSfx.play().catch(() => {});

            setTimeout(() => {
                introBlack.classList.add("fade-out");
            }, 260);

            setTimeout(() => {
                initLivingRoomScene();
            }, 1550);
        }

        function enterBedroomScene() {
            inLivingRoom = false;
            walkingSfx.pause();
            walkingSfx.currentTime = 0;
            sceneBg.style.backgroundImage = 'url("bedroom-bg.png")';
            sceneBg.style.filter = "brightness(0.74) saturate(0.92)";
            doorHotspot.classList.remove("active");
            doorInstruction.classList.remove("active");
            setDialogueSpeaker("");
            typeDialogue("You step into your room...", null, 28);

            setTimeout(() => {
                blueWash.classList.add("active");
                sceneBg.style.filter = "brightness(0.8) saturate(1.04)";
                setDialogueSpeaker("You");
                typeDialogue(
                    '"That\'s weird... I thought I turned my computer off before going to school... why is it on... did mom use it or something? Maybe its a system update..."',
                    () => {
                        monitorHotspot.classList.add("active");
                        computerInstruction.classList.add("active");
                    },
                    28
                );
            }, 2000);
        }

        startIntroSequence();
        buildCodeRain();

        eduContinueBtn.addEventListener("click", () => {
            if (!collapseOverlay.classList.contains("show-edu")) return;
            eduPopup.classList.remove("active");
            collapseOverlay.classList.remove("show-edu");
            collapseOverlay.classList.add("show-code");
            typeCollapseText("WELCOME HOME", () => {
                setTimeout(() => {
                    window.location.href = "page1.html";
                }, 420);
            }, 185);
        });

        doorHotspot.addEventListener("click", () => {
            if (!inLivingRoom) return;
            doorHotspot.classList.remove("active");
            doorInstruction.classList.remove("active");
            walkingSfx.currentTime = 0;
            walkingSfx.loop = true;
            walkingSfx.volume = 0.85;
            walkingSfx.play().catch(() => {});
            setDialogueSpeaker("");
            typeDialogue("You head toward your bedroom door.", null, 28);
            setTimeout(enterBedroomScene, 1400);
        });

        monitorHotspot.addEventListener("click", () => {
            if (sceneLocked) return;
            sceneLocked = true;
            monitorHotspot.classList.remove("active");
            computerInstruction.classList.remove("active");
            setDialogueSpeaker("");
            typeDialogue("The monitor flares alive. A social media alert pops up.", () => {
                setTimeout(() => {
                    notificationSfx.currentTime = 0;
                    notificationSfx.volume = 0.9;
                    notificationSfx.play().catch(() => {});
                    chatLayer.classList.add("active");
                }, 400);
            }, 28);
        });

        declineBtn.addEventListener("click", () => {
            declineBtn.disabled = true;
            declineBtn.textContent = "DECLINED...";
            setDialogue("Something about the request keeps pulling your attention back.");
            setTimeout(() => {
                declineBtn.disabled = false;
                declineBtn.textContent = "DECLINE";
            }, 1300);
        });

        acceptBtn.addEventListener("click", () => {
            notification.style.display = "none";
            chatLayer.classList.add("chat-open");
            chatWindow.classList.add("active");
            runChat();
        });

        async function runChat() {
            addMessage("npc", "Protocol_9", "Hey. Finally made it home?");
            const introChoice = await chooseOption(["Who are you?", "How did you know?"]);
            await wait(700);
            if (introChoice === "Who are you?") {
                addMessage("npc", "Protocol_9", "Someone who knows a pro when they see one.");
            } else {
                addMessage("npc", "Protocol_9", "I keep tabs on the leaderboards. You've been active.");
            }
            await wait(950);

            addMessage("npc", "Protocol_9", "I've also been tracking, particulary, your stats on the global leaderboards. You're 'The_Architect', right? Your logic scores are... impressive.");
            const architectChoice = await chooseOption(["Yeah, that's me.", "Who's asking?"]);
            await wait(700);
            if (architectChoice === "Yeah, that's me.") {
                addMessage("npc", "Protocol_9", "Good. I like confidence.");
            } else {
                addMessage("npc", "Protocol_9", "A fan. Or a recruiter, if you're as good as the data says.");
            }
            await wait(950);

            addMessage("npc", "Protocol_9", "I'm also someone who appreciates talent. Most people play games just to pass the time. You play to win.");
            await wait(1000);

            addMessage("npc", "Protocol_9", "I’m working on a project that’s too 'smart' for the general public. It’s an AI companion, but it’s self-evolving. It learns your moods, your secrets... it becomes the perfect friend.");
            const aiChoice = await chooseOption(["An AI friend?", "Sounds creepy."]);
            await wait(700);
            if (aiChoice === "An AI friend?") {
                addMessage("npc", "Protocol_9", "Exactly. A companion that's built specifically for you.");
            } else {
                addMessage("npc", "Protocol_9", "People said that about the internet once, too. Innovation feels 'off' at first.");
            }
            await wait(950);

            addMessage("npc", "Protocol_9", "I mean, isn't it amazing to have someone who understands you? Someone who won't judge you after a long, tiring day at school?");
            await wait(1050);

            addMessage("npc", "Protocol_9", "I call it Pixel. I've seen the way you play — you're the only one I trust to give it the right 'personality' during the test phase.");
            const trustChoice = await chooseOption(["I'm flattered.", "Why me?"]);
            await wait(700);
            if (trustChoice === "I'm flattered.") {
                addMessage("npc", "Protocol_9", "You should be. I've screened hundreds. You're the one.");
            } else {
                addMessage("npc", "Protocol_9", "Because you think outside the box. I don't need a mindless tester.");
            }
            await wait(950);

            addMessage("npc", "Protocol_9", "And you're tired of the 'normal' world, aren't you? You want something more, don't you? Something that's just for you.");
            await wait(1050);

            addMessage("npc", "Protocol_9", "I'm sending the master build over. This is a one-time link. Don't share it with anyone. Not even your parents.");
            const safetyChoice = await chooseOption(["I won't.", "Is it safe?"]);
            await wait(700);
            if (safetyChoice === "I won't.") {
                addMessage("npc", "Protocol_9", "Good. Loyalty is a rare trait these days.");
            } else {
                addMessage("npc", "Protocol_9", "It's custom-encrypted. Cleaner than any public app store.");
            }
            await wait(950);

            addMessage("npc", "Protocol_9", "So, don't worry. It's safer than the real world. Enjoy your new best friend.");
            await wait(1000);

            addFileAttachment();
            setDialogue("A file appears in the chat.");
        }

        function startGlitchSequence() {
            setDialogue("You click Pixels_Playhouse.exe...");

            chatLayer.style.pointerEvents = "none";

            // Stage 1: SFX starts.

            setTimeout(() => {
                // Stage 2: screen shake.
                gameFrame.classList.add("shaking");
            }, 500);

            setTimeout(() => {
                // Stage 3: heavy glitch overlay.
                glitchLayer.classList.add("active");
                glitchSfx.currentTime = 0;
                glitchSfx.volume = 0.8;
                glitchSfx.play().catch(() => {});
                sceneBg.style.filter = "brightness(0.95) saturate(1.2)";
            }, 950);

            setTimeout(() => {
                // Stage 4: collapse to line, then dot, then black.
                collapseText.textContent = "";
                collapseOverlay.classList.remove("show-code", "show-edu", "blackout", "collapse");
                eduPopup.classList.remove("active");
                collapseOverlay.classList.add("active", "collapse");
            }, 1700);

            setTimeout(() => {
                // Stage 5: full black.
                gameFrame.classList.remove("shaking");
                glitchLayer.classList.remove("active");
                collapseOverlay.classList.add("blackout");
            }, 2450);

            setTimeout(() => {
                // Stage 5b: one second later, educational popup appears.
                collapseOverlay.classList.add("show-edu");
                eduPopup.classList.add("active");
            }, 3450);
        }
    </script>
</body>
</html>
