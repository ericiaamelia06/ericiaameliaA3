<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>Start Journey</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Science+Gothic:wght@100..900&family=Share+Tech&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
        /* --- GLOBAL & RESET --- */
        body{
                margin:0;
                padding:0;
                background:black;
                overflow:hidden;
                font-family:"Share Tech", sans-serif;
                color:#dffaff;
        }

        .room-wrapper{
                position:relative;
                width:960px;
                height:540px;
                margin:0 auto;
                overflow:hidden;
                background:black;
                transition: filter 0.1s; /* Smooths out the glitch ending */
        }

        /* BACKGROUND */
        .room-bg{
                position:absolute;
                width:100%;
                height:100%;
                object-fit:cover;
                z-index:0;
        }

        .room-overlay{
                position:absolute;
                inset:0;
                background:radial-gradient(circle at center, 
                        rgba(10, 20, 40, 0.3) 0%, 
                        rgba(0, 0, 0, 0.8) 100%);
                z-index:1;
                pointer-events: none;
        }

        .particle{
                position: absolute;
                background: #00eaff;
                border-radius: 50%;
                pointer-events: none;
                z-index: 3;
                filter: blur(0.5px);
                box-shadow: 0 0 10px #00eaff, 0 0 20px #00eaff;
                opacity: 0;
                animation: floatParticle var(--duration) linear infinite;
        }

        @keyframes floatParticle {
        0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
        }
        20%, 60% {
                opacity: 1; 
        }
        100% {
                transform: translateY(var(--moveY)) translateX(var(--moveX));
                opacity: 0;
        }
        }

        /* PIXEL CHARACTER */
        .pixel-character{
                position:absolute;
                left:41%;
                bottom:117px;
                width:360px;
                transform:translateX(-50%);
                z-index:5;
                filter: drop-shadow(0 0 15px rgba(0,234,255,0.4));
                animation: 
                        float 3s ease-in-out infinite,
                        pulseGlow 7s ease-in-out infinite;
        }

        @keyframes float{
                0% { transform: translate(-50%, 0px); }
                50% { transform: translate(-50%, -15px); }
                100% { transform: translate(-50%, 0px); }
        }
        @keyframes pulseGlow{
                0% { filter: drop-shadow(0 0 4px #00eaff88); }
                50% { filter: drop-shadow(0 0 14px #00eaffcc); }
                100% { filter: drop-shadow(0 0 4px #00eaff88); }
        }

        /* --- GLITCH ANIMATIONS --- */
        
        /* WEAK GLITCH */
        .glitch-weak {
                animation: glitch-anim-1 0.2s ease-in-out infinite;
                /* Subtle color separation without moving the element box */
                filter: brightness(1.2) drop-shadow(2px 0px 0px #ff0055) drop-shadow(-2px 0px 0px #00eaff);
        }

        @keyframes glitch-anim-1 {
                0%, 100% { 
                        clip-path: inset(0 0 0 0);
                        filter: hue-rotate(0deg) brightness(1);
                }
                20% { 
                        /* Horizontal slice */
                        clip-path: inset(20% 0 50% 0); 
                        filter: hue-rotate(15deg) brightness(1.3);
                }
                40% { 
                        clip-path: inset(60% 0 10% 0);
                        filter: hue-rotate(-15deg);
                }
                60% { 
                        /* Digital "stutter" effect */
                        clip-path: inset(10% 5% 80% 5%);
                        filter: brightness(1.5);
                }
                80% { 
                        clip-path: inset(40% 0 40% 0);
                        filter: hue-rotate(5deg);
                }
        }

        /* STRONG GLITCH */
        .glitch-strong {
                animation: glitch-anim-2 0.15s steps(2) infinite; /* Faster and choppier */
                filter: contrast(3) hue-rotate(-45deg) brightness(1.5);
        }
        
        @keyframes glitch-anim-2 {
                0% { 
                        clip-path: inset(80% 0 1% 0); 
                        filter: invert(1) hue-rotate(90deg);
                }
                20% { 
                        clip-path: inset(20% 0 60% 0); 
                        filter: contrast(2) brightness(2);
                }
                40% { 
                        clip-path: inset(40% 0 40% 0); 
                        filter: invert(0);
                }
                60% { 
                        clip-path: inset(10% 0 85% 0); 
                        filter: hue-rotate(-90deg);
                }
                80% { 
                        clip-path: inset(50% 0 20% 0); 
                        filter: brightness(0.5);
                }
                100% { 
                        clip-path: inset(0 0 0 0);
                }
        }

        /* DIALOGUE BOX */
        .speech-wrapper{
                position:absolute;
                top:15px;
                left:150px;
                width:520px;
                z-index:4;
                display: flex;
                justify-content: center;
                align-items: center;
        }
        
        .speech-img{
                width:110%;
                filter:drop-shadow(0 0 10px rgba(0,255,255,0.35));
                user-select:none;
                display:block;
        }
        
        .speech-text{
                position: absolute;
                width: 85%;   
                height: 65%;  
                top: 13%;
                font-size: 19px;
                font-weight: 500;
                color: #003d4f;
                line-height: 1.4;
                font-family: "Share Tech", sans-serif;
                pointer-events: none;
                display: flex;
                align-items: center;    
                justify-content: center; 
                text-align: center;
                white-space: pre-line;
                opacity: 1;
        }

        /* CHOICES BUTTONS */
        .choices-container{
                position:absolute;
                bottom:40px;
                left:41%;
                transform:translateX(-50%);
                display:flex;
                gap:20px;
                z-index:20;
        }

        .choice-btn{
                background:rgba(10, 20, 40, 0.85);
                border:2px solid #00eaff;
                color:#c8f9ff;
                padding: 10px 18px;
                border-radius:15px;
                font-family:"Share Tech Mono", monospace;
                font-size:18px;
                cursor:pointer;
                box-shadow:0 0 15px #00eaff66;
                transition:0.2s all;
                text-transform:uppercase;
        }

        .choice-btn:hover{
                background:#00eaff22;
                transform:scale(1.05);
                box-shadow:0 0 25px #00eaff;
        }

        /* INFO METER [RIGHT SIDE]*/
        .meter-box{
                position:absolute;
                right:85px;
                top:120px;
                width:90px;
                height:340px;
                background:rgba(12, 26, 43, 0.9);
                border:2px solid #00eaff;
                border-radius:12px;
                padding:10px;
                display:flex;
                flex-direction:column;
                align-items:center;
                box-shadow:0 0 20px #00eaff44;
                z-index:8;
                backdrop-filter: blur(5px);
        }

        .meter-title{
                font-family:"Share Tech Mono",monospace;
                color:#a9faff;
                font-size:14px;
                margin-bottom:8px;
                text-shadow:0 0 5px #00eaff;
                text-align:center;
        }

        .meter-frame{
                width:30px;
                flex-grow:1;
                background:#000;
                border: 1px solid #005f6b;
                border-radius: 4px;
                padding: 2px;
                display: flex;
                flex-direction: column-reverse;
                gap: 2px;
                overflow:hidden;
        }

        .meter-percent { 
                margin-top: 10px; 
                font-family: "Share Tech Mono"; 
                font-size: 16px; 
                color: #fff; 
        }

        /* Individual LED Segment */
        .segment {
                width: 100%;
                height: 12.2px; 
                flex-shrink: 0; /* ADD THIS: Prevents segments from squishing */
                background: #1a3344; 
                border-radius: 1px;
                transition: background 0.3s, box-shadow 0.3s;
        }

        /* Lit States */
        .lit-safe { background: #00eaff; box-shadow: 0 0 8px #00eaff; }
        .lit-warn { background: #ffcc00; box-shadow: 0 0 8px #ffcc00; }
        .lit-danger { background: #ff0055; box-shadow: 0 0 8px #ff0055; }

        /* GHOST PREVIEW STATE */
        .lit-ghost { 
                background: rgba(255, 255, 255, 0.3); 
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); 
        }

        /* Specific Ghost Previews */
        .ghost-blue { 
        background: rgba(0, 234, 255, 0.3) !important; 
        box-shadow: 0 0 8px rgba(0, 234, 255, 0.4); 
        }

        .ghost-orange { 
        background: rgba(255, 165, 0, 0.3) !important; 
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.4); 
        }

        /* --- TRUST METER (Left Side) --- */
        .trust-box {
                position: absolute;
                right: 30px; 
                top: 20px;
                z-index: 8;
                display: flex;
                flex-direction: column;
                align-items: flex-start; /* Keeps the label aligned with the start of the bar */
        }

        .trust-label {
                font-family: "Share Tech Mono", monospace;
                color: #00ff88;
                font-size: 14px;
                margin-bottom: 5px;
                margin-left: 50px; /* Aligns label with the bar instead of the heart */
                text-transform: uppercase;
        }

        .trust-frame {
                width: 200px;
                height: 34px;
                background: rgba(12, 26, 43, 0.9);
                border: 2px solid #00eaff; /* Match the cyan glow in the reference */
                border-radius: 20px;
                display: flex;
                align-items: center;
                position: relative;
                padding-right: 4px; /* Slight padding for the end of the bar */
        }

        .heart-icon {
                width: 50px; 
                height: 50px;
                background: #0c1a2b;
                border: 2px solid #00eaff;
                border-radius: 50%;
                position: absolute;
                left: -20px; /* Pulls heart halfway off the bar like the reference */
                display: flex; 
                justify-content: center; 
                align-items: center;
                font-size: 26px; 
                color: #ff0055;
                box-shadow: 0 0 15px rgba(0, 234, 255, 0.4);
                z-index: 10;
        }

        .trust-bar-bg {
                width: 100%; 
                height: 22px; /* Smaller than frame to show the background "track" */
                background: #000;
                border-radius: 15px;
                overflow: hidden;
                margin-left: 25px; /* Pushes the start of the bar past the heart center */
                margin-right: 5px;
        }

        .trust-fill {
                width: 10%; 
                height: 100%;
                /* Gradient matching the screenshot's green-to-yellow look */
                background: linear-gradient(90deg, #00ff88, #ccff00); 
                transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);

                animation: trust-glow 2s ease-in-out infinite;
                transition: width 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }

        @keyframes trust-glow {
                0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 136, 0.5); }
                50% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.9); }
        }

        .heart-pop {
                animation: heart-beat 0.4s ease-out;
        }

        @keyframes heart-beat {
                0% { transform: scale(1); }
                50% { transform: scale(1.4); }
                100% { transform: scale(1); }
        }

        /* --- POPUPS --- */
        .modal-overlay{
                position:absolute;
                top:0; left:0;
                width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
                backdrop-filter: blur(4px);
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
                opacity: 1;
                visibility: visible;
        }

        .popup-box{
                width: 520px;
                padding: 30px;
                background: #0c1a2b;
                border: 2px solid #00eaff;
                border-radius: 20px;
                color:#d2faff;
                font-size:20px;
                display:flex;
                align-items: center;
                gap:20px;
                box-shadow:0 0 30px #00eaff55;
                text-align:center;
        }

        .popup-alert-icon{
                width: 90px;
                height: 90px;
                margin-bottom:10px;
                filter: drop-shadow(0 0 8px #00eaff88);
        }

        .popup-message-container{
                flex:1;
                text-align:left;
                line-height:1.4;
        }

        .popup-title{
                color: #00eaff;
                font-family: "Share Tech Mono", monospace;
                font-size: 30px;
                margin: 0 0 5px 0;
                text-shadow: 0 0 2px #00eaff;
        }

        .popup-text{
                font-size: 20px;
                color: #dffaff;
                line-height: 1.5;
                margin-bottom: 25px;
                text-align: center;
        }

        .action-btn {
                padding: 10px 30px;
                background: linear-gradient(180deg, #001c24, #00303d);
                border: 2px solid #00eaff;
                color: #fff;
                border-radius: 25px;
                font-family: "Share Tech Mono", monospace;
                font-size: 22px;
                display:block;
                margin-top:15px;
                cursor: pointer;
                box-shadow: 0 0 10px #00eaff inset;
                transition: 0.3s ease;
                text-shadow: 0 0 4px #00eaff;
        }

        .action-btn:hover {
                background: #00eaff;
                transform:scale(1.05);
                box-shadow: 0 0 15px #00eaff inset, 0 0 20px #00eaff;
                color: #000;
        }

        #taskPopup .popup-box{
                width: 600px;
                height:420px;
                position:relative;
                flex-direction:column;
                text-align:center;
                padding:20px;
                justify-content: space-around;
        }

        #taskBtn {
                position: absolute;
                bottom: 30px; 
                left: 50%;
                transform: translateX(-50%);
                padding: 10px 40px;
                background: #001c24;
                border: 2px solid #00eaff;
                border-radius: 30px;
                color: #bffaff;
                font-family: "Share Tech Mono", monospace;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 0 10px #00eaff inset;
                transition: 0.3s;
        }

        #taskBtn:hover {
                background: #00eaff22;
                box-shadow: 0 0 15px #00eaff inset, 0 0 20px #00eaff;
        }

        #taskStatus {
                position: absolute;
                bottom: 100px; 
                font-size: 20px; /* Reduced from 30px to fit better */
                color: #00eaff;
                font-family: "Share Tech Mono", monospace;
        }

        /* INTERACTIVE TASK BOX*/
        .dnd-wrapper {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: -10px;
                margin-bottom:30px;
                width:100%;
        }

        .drop-zone {
                width: 45%;
                height: 130px; /* Keep the fixed height you want */
                border: 2px dashed #00eaff;
                background: rgba(0, 234, 255, 0.05);
                border-radius: 10px;
                display: flex;
                flex-direction: row; 
                flex-wrap: wrap;    
                align-items: flex-start; 
                justify-content: center;
                padding: 10px;
                gap: 10px;
                box-sizing: border-box;
                
                /* THE SCROLL FIX */
                overflow-y: auto;  
                overflow-x: hidden; 
        }

        .drop-zone::-webkit-scrollbar {
                width: 6px;
        }

        .drop-zone::-webkit-scrollbar-thumb {
                background: #00eaff;
                border-radius: 10px;
                box-shadow: 0 0 5px #00eaff;
        }
        
        .drop-zone::-webkit-scrollbar-track {
                background: rgba(0, 234, 255, 0.1);
        }

        .drop-title {
                color: #00eaff;
                font-size: 16px;
                margin-bottom: 5px;
                text-transform: uppercase;
                width: 100%;
        }

        .source-container {
                display: flex;
                justify-content: center;
                gap: 15px;
                width:100%;
                margin-top:-20px;
                padding-bottom: 15px;
                min-height: 100px;
                align-items:center;
        }

        .draggable-item {
                background: #ff0055;
                color: #fff;
                border: 2px solid #fff;
                border-radius: 12px;
                cursor: grab;
                box-shadow: 0 0 15px rgba(255, 0, 85, 0.6);
                user-select: none;
                display:flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap:2px;
                width:85px;
                height:80px;
                flex-shrink: 0;
                box-sizing:border-box;
                transition: transform 0.2s, box-shadow 0.2s;
        }

        .draggable-item:hover {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255, 0, 85, 0.8);
        }

        .item-icon{
                width:40px;
                height:40px;
                object-fit:contain;
                pointer-events:none;
                margin-top:2px;
        }

        #school-icon{
                width:65px;
                height:65px;
                margin-bottom:-15px;
        }

        .draggable-item span {
                font-family: "Share Tech Mono", monospace;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-weight:bold;
        }

        .item-success {
                background: #00ff88 !important; 
                border-color: #ffffff !important;
                box-shadow: 0 0 25px rgba(0, 255, 136, 0.9) !important;
                transform: scale(0.8);
                animation: pop 0.3s ease-out;
                transition: all 0.3s ease;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); } 
            100% { transform: scale(1); }    
        }

        .hidden { display: none !important; }
</style>
</head>

<body>

    <div class="room-wrapper" id="roomWrapper">
        <img src="background-for-page2.2.png" class="room-bg" alt="Background">
        <div class="room-overlay"></div>

        <img src="stage3 pixel homepage.png" class="pixel-character" alt="Pixel">

        <div class="trust-box">
            <div class="trust-label">TRUST METER</div>
            <div class="trust-frame">
                <div class="heart-icon">‚ù§</div>
                <div class="trust-bar-bg">
                    <div class="trust-fill" id="trustFill"></div>
                </div>
            </div>
        </div>

        <div class="meter-box">
            <div class="meter-title">INFO METER</div>
            <div class="meter-frame" id="meterFrame"></div>
            <div class="meter-percent" id="meterText">0%</div>
        </div>

        <div class="choices-container">
            <button class="choice-btn" 
                onmouseenter="previewMeter(65)" 
                onmouseleave="clearPreview()" 
                onclick="triggerTask('high')">
                Share Freely (Overshare)
            </button>
            <button class="choice-btn" 
                onmouseenter="previewMeter(25)" 
                onmouseleave="clearPreview()" 
                onclick="triggerTask('low')">
                Share Minimal Info
            </button>
        </div>

        <div id="startPopup" class="modal-overlay active">
            <div class="popup-box">
                <img src="alert-icon-yellow.png" class="popup-alert-icon" alt="!">
                <div class="popup-message-container">
                        <h2 class="popup-title">REMEMBER:</h2>
                        <p class="popup-text">
                        Pixel adapts to everything you tell it.<br>
                        Be mindful of what you reveal.
                        </p>
                        <button class="action-btn" onclick="closeStart()">START</button>
                </div>
            </div>
        </div>

        <div id="taskPopup" class="modal-overlay">
            <div class="popup-box">
                <h2 class="popup-title">WAIT! WHAT DID PIXEL LEARN?</h2>
                <p style="color:#aaa; font-size:16px; margin-bottom:20px;">
                    Drag the items into the boxes.
                </p>

                <div class="dnd-wrapper">
                    <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <span class="drop-title">Pixel Collected</span>
                    </div>
                    <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <span class="drop-title">Pixel Didn't Know</span>
                    </div>
                </div>

                <div class="source-container" id="sourceList">
                        <div class="draggable-item" draggable="true" ondragstart="drag(event)" id="item1">
                                <img src="house-icon.png" class="item-icon">
                                <span>Location</span>
                        </div>

                        <div class="draggable-item" draggable="true" ondragstart="drag(event)" id="item2">
                                <img src="game-icon.png" class="item-icon">
                                <span>Hobbies</span>
                        </div>
                    
                        <div class="draggable-item" draggable="true" ondragstart="drag(event)" id="item3">
                                <img src="school-icon.png" class="item-icon" id="school-icon">
                                <span>School</span>
                        </div>

                        <div class="draggable-item" draggable="true" ondragstart="drag(event)" id="item4">
                                <img src="birthday-icon.png" class="item-icon">
                                <span>Birthday</span>
                        </div>

                        <div class="draggable-item" draggable="true" ondragstart="drag(event)" id="item5">
                                <img src="family-icon.png" class="item-icon">
                                <span>Family</span>
                        </div>
                </div>

                <div id="taskStatus"></div>

                <button id="taskBtn" class="action-btn hidden" onclick="finishTask()">CONTINUE</button>
            </div>
        </div>

        <div id="tipPopup" class="modal-overlay">
            <div class="popup-box">
                <img src="alert-icon-yellow.png" class="popup-alert-icon" alt="!">
                <div class="popup-message-container">
                        <h2 class="popup-title" style="color: #ffcc00; text-shadow: 0 0 2px #ffcc00;">DID YOU KNOW?</h2>
                        <p class="popup-text">
                        Small bits of info can reveal a lot.<br>
                        AI pieces details together quickly to build a profile of you.
                        </p>
                        <button class="action-btn" onclick="nextPage()">CONTINUE</button>
                </div>
            </div>
        </div>

        <div class="speech-wrapper">
                <img src="Speech Bubble.png" class="speech-img">
                <div class="speech-text" id="speechText"></div>
        </div>

    </div>

    <script>
        const dialogue = "Tell me more about you! What's your favourite colour?\nWhat school do you go to? What do you like doing?";
        
        // --- ADDED THIS SECTION ---
        // We need to define 'room' and 'isLocked' or the script will crash
        const room = document.getElementById('roomWrapper');
        let isLocked = false; 
        
        const dingSound = new Audio('ding.mp3')
        
        // Generate 25 LED segments for the meter
        const meterFrame = document.getElementById('meterFrame');
        for(let i=0; i<25; i++){
            let seg = document.createElement('div');
            seg.className = 'segment';
            seg.id = 'seg-' + i;
            meterFrame.appendChild(seg);
        }

        // --- FUNCTIONS ---
        function closeStart() {
            document.getElementById('startPopup').classList.remove('active');
            typeWriter(document.getElementById('speechText'), dialogue);
        }

        function typeWriter(element, text) {
            element.innerHTML = "";
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 30);
                }
            }
            type();
        }

        function createParticles() {
        const wrapper = document.getElementById('roomWrapper');
        // INCREASED: from 20 to 60 for a richer look
        const particleCount = 40; 

        for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                
                // INCREASED: sizes are now 3px to 8px for better visibility
                const size = Math.random() * 5 + 3 + 'px';
                p.style.width = size;
                p.style.height = size;

                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';

                const moveX = (Math.random() - 0.5) * 200 + 'px'; 
                const moveY = -(Math.random() * 200 + 100) + 'px'; 
                const duration = Math.random() * 4 + 4 + 's'; // Slightly faster movement
                const delay = Math.random() * 5 + 's';

                p.style.setProperty('--moveX', moveX);
                p.style.setProperty('--moveY', moveY);
                p.style.setProperty('--duration', duration);
                p.style.animationDelay = delay;

                wrapper.appendChild(p);
        }
        }

        // Call it when the window loads
        window.onload = () => {
        createParticles();
        // Your existing closeStart() logic or other init code
        };

        // --- METER PREVIEW (GHOSTING) ---
        function previewMeter(percent) {
        if(isLocked) return;
        
        // Calculate based on 18 segments (leaving 7 blank at top)
        const segmentsToFill = Math.floor((percent / 100) * 18);
        
        // Pick the color class based on the percentage
        let ghostClass = 'lit-ghost'; // Default
        if (percent === 65) ghostClass = 'ghost-orange';
        if (percent === 25) ghostClass = 'ghost-blue';

        for(let i=0; i<25; i++) {
                let seg = document.getElementById('seg-' + i);
                
                // Remove any existing ghost classes first
                seg.classList.remove('lit-ghost', 'ghost-blue', 'ghost-orange');
                
                if(i < 18 && i < segmentsToFill) {
                seg.classList.add(ghostClass);
                }
        }
    
    document.getElementById('meterText').innerText = percent + "%";
    document.getElementById('meterText').style.color = "#aaa"; 
}

        function clearPreview() {
        if(isLocked) return;
        for(let i=0; i<25; i++) {
                let seg = document.getElementById('seg-' + i);
                // Clean up all ghost variants
                seg.classList.remove('lit-ghost', 'ghost-blue', 'ghost-orange');
        }
        document.getElementById('meterText').innerText = "0%";
        document.getElementById('meterText').style.color = "#fff";
        }

        // --- ACTION LOGIC ---
        const glitchSfx = new Audio('glitch-sfx.mp3');

        function triggerTask(riskLevel) {
        isLocked = true;
        const character = document.querySelector('.pixel-character');
        const room = document.getElementById('roomWrapper'); // Ensure room is defined
        
        glitchSfx.currentTime = 0; 
        
        if (riskLevel === 'high') {
                glitchSfx.volume = 1.0; 
                glitchSfx.play();
                room.classList.add('glitch-strong');
                character.classList.add('glitch-strong');
                fillMeter(65, 'lit-warn');
                document.getElementById('trustFill').style.width = "90%";
                
                setTimeout(() => {
                room.classList.remove('glitch-strong');
                character.classList.remove('glitch-strong');
                }, 600);
        } else {
                glitchSfx.volume = 0.3; 
                glitchSfx.play();
                room.classList.add('glitch-weak');
                character.classList.add('glitch-weak');
                fillMeter(25, 'lit-safe');
                document.getElementById('trustFill').style.width = "20%";
                
                setTimeout(() => {
                room.classList.remove('glitch-weak');
                character.classList.remove('glitch-weak');
                }, 600);

                const heart = document.querySelector('.heart-icon');
                heart.classList.add('heart-pop');

                // Remove the class after animation so it can be triggered again
                setTimeout(() => {
                heart.classList.remove('heart-pop');
                }, 400);
        }

        setTimeout(() => {
                document.getElementById('taskPopup').classList.add('active');
        }, 1000);
        }

        function fillMeter(percentage, colorClass) {
                let segmentsToFill = Math.floor((percentage / 100) * 25);
                // 1. Change the loop to 20
                for(let i=0; i<20; i++){
                let seg = document.createElement('div');
                seg.className = 'segment';
                seg.id = 'seg-' + i;
                meterFrame.appendChild(seg);
                }

                // 2. Update previewMeter math (change 25 to 20)
                function previewMeter(percent) {
                if(isLocked) return;
                const segmentsToFill = Math.floor((percent / 100) * 20); // Changed to 20
                for(let i=0; i<20; i++) { // Changed to 20
                        let seg = document.getElementById('seg-' + i);
                        // ... rest of code
                }
                }

                // 3. Update fillMeter math (change 25 to 20)
                function fillMeter(percentage, colorClass) {
                let segmentsToFill = Math.floor((percentage / 100) * 20); // Changed to 20
                for(let i=0; i<20; i++) { // Changed to 20
                        let seg = document.getElementById('seg-' + i);
                        // ... rest of code
                }
                }
        }

        // --- DRAG AND DROP ---
        function allowDrop(ev) {
                ev.preventDefault();
        }

        function drag(ev) {
                ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        var draggedElement = document.getElementById(data);
        let target = ev.target.closest('.drop-zone');
        
        if (target) {
                // --- IMPROVED SOUND LOGIC ---
                // Creating a new Audio object here ensures overlapping sounds play correctly
                let instanceDing = new Audio('ding.mp3');
                instanceDing.volume = 0.6; // Optional: adjust volume
                instanceDing.play();

                target.appendChild(draggedElement);
                draggedElement.classList.add('item-success');
                draggedElement.setAttribute("draggable", "false");
                draggedElement.style.cursor = "default";

                // Auto-scroll to the bottom of the zone
                target.scrollTop = target.scrollHeight;

                checkCompletion();
        }
        }

        function checkCompletion() {
            const source = document.getElementById('sourceList');
            // If the source list has no children left, the task is done
            if (source.children.length === 0) {
                document.getElementById('taskStatus').innerText = "Analyzing data...";
                setTimeout(() => {
                    document.getElementById('taskStatus').innerText = "Data Processed!";
                    document.getElementById('taskStatus').style.color = "#00eaff";
                    document.getElementById('taskBtn').classList.remove('hidden');
                }, 600);
            }
        }

        function finishTask() {
            document.getElementById('taskPopup').classList.remove('active');
            document.getElementById('tipPopup').classList.add('active');
        }

        function nextPage() {
            window.location.href = "page4.html";
        }

    </script>
</body>
</html>